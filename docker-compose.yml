version: '3.9'

services:
  app:
    image: ghcr.io/timomeh/timomeh.de:sqlite
    build:
      context: .
      target: runner
    ports:
      - '3000:3000'
    volumes:
      - .next/cache/fetch-cache:/app/.next/cache/fetch-cache
      - ./db-data:/app/db-data
    env_file:
      - path: ./.env
        required: false
      - path: ./.env.local
        required: false
      - path: ./.env.production
        required: false
  migrate:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-slim AS base
        ENV PNPM_HOME="/pnpm"
        ENV PATH="$PNPM_HOME:$PATH"
        COPY package.json ./
        RUN corepack enable && corepack prepare --activate
        WORKDIR /app

        FROM base AS deps
        COPY package.json pnpm-lock.yaml* .npmrc* ./
        RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

        FROM base
        COPY . .
        COPY --from=deps /app/node_modules /app/node_modules
        CMD ["pnpm", "drizzle-kit", "push", "--force"]
    restart: no
    volumes:
      - ./db-data:/app/db-data/
